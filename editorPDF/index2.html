<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor PDF Pro + AutoFirma (Híbrid)</title>
    
    <!-- Estils: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Llibreries: PDF-Lib i PDF.js -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Icones: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 
        ========================================================================
        ZONA D'INTEGRACIÓ DE AUTOSCRIPT.JS
        ========================================================================
        Si vols que funcioni sense dependències, copia tot el contingut del 
        fitxer autoscript.js i enganxa'l just a sota d'aquest comentari, 
        dins de l'etiqueta <script>.
    -->
    <script id="inline-autoscript">
        // ENGANXA EL CODI DE autoscript.js AQUÍ (Opcional)
        // Si no ho fas, el programa t'ho demanarà via interfície gràfica.
    </script>

    <style>
        .page-card { transition: all 0.2s ease-in-out; }
        .page-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loading-overlay { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); }
        .disabled-ui { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        #selectionCanvas { cursor: crosshair; touch-action: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col font-sans">

    <!-- Contenidor AutoScript -->
    <div id="appletContainer" style="width:1px; height:1px; position:absolute; top:-100px;"></div>

    <!-- MODAL D'EMERGÈNCIA PER CARREGAR AUTOSCRIPT -->
    <div id="manualScriptLoader" class="hidden fixed inset-0 z-[200] bg-gray-900 bg-opacity-95 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 flex flex-col h-[80vh]">
            <div class="flex items-center gap-3 mb-4 text-amber-600 border-b pb-4">
                <i data-lucide="file-code" class="w-8 h-8"></i>
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Falta la llibreria AutoScript</h2>
                    <p class="text-sm text-gray-600">No s'ha trobat `autoscript.js` ni s'ha integrat al codi.</p>
                </div>
            </div>
            
            <p class="mb-2 text-sm text-gray-700 font-medium">Solució Ràpida: Obre el fitxer <code>autoscript.js</code> amb el bloc de notes, copia tot el text i enganxa'l aquí sota:</p>
            
            <textarea id="pastedScriptArea" class="flex-grow w-full border border-gray-300 rounded-lg p-3 font-mono text-xs bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none mb-4" placeholder="// Enganxa aquí el codi de autoscript.js..."></textarea>
            
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('manualScriptLoader').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancel·lar</button>
                <button onclick="loadPastedScript()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow flex items-center gap-2">
                    <i data-lucide="play" class="w-4 h-4"></i> Carregar i Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- Capçalera -->
    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i data-lucide="shield-check" class="text-emerald-600 w-8 h-8"></i>
                <h1 class="text-xl font-bold text-slate-800">Editor PDF <span class="text-emerald-600">Crypto</span></h1>
            </div>
            <div class="flex gap-3">
                <button onclick="document.getElementById('mainPdfInput').click()" id="uploadBtn" class="flex items-center gap-2 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition text-sm font-medium">
                    <i data-lucide="upload" class="w-4 h-4"></i> Carregar PDF
                </button>
                <button onclick="downloadPdf()" id="saveBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium opacity-50 cursor-not-allowed" disabled>
                    <i data-lucide="save" class="w-4 h-4"></i> Descarregar
                </button>
            </div>
        </div>
    </header>

    <!-- Estat AutoFirma -->
    <div id="afConnectionStatus" class="bg-slate-100 border-b border-slate-200 px-4 py-1 text-xs flex justify-between items-center">
        <span class="flex items-center gap-2">
            Estat AutoFirma: 
            <span id="afStatusDot" class="w-2 h-2 rounded-full bg-gray-400"></span>
            <span id="afStatusText" class="text-gray-500">Comprovant llibreria...</span>
        </span>
        <button onclick="checkAndInitAutoFirma()" class="text-blue-600 hover:underline">Re-intentar connexió</button>
    </div>

    <!-- Inputs Ocults -->
    <input type="file" id="mainPdfInput" accept="application/pdf" class="hidden">
    <input type="file" id="mergePdfInput" accept="application/pdf" class="hidden">
    <input type="file" id="signatureFileInput" accept="image/png, image/jpeg, image/jpg" class="hidden">

    <!-- Contingut Principal -->
    <main class="flex-grow p-6 max-w-7xl mx-auto w-full">
        <div id="emptyState" class="flex flex-col items-center justify-center h-64 border-2 border-dashed border-slate-300 rounded-xl bg-white">
            <i data-lucide="file-key" class="w-12 h-12 text-slate-400 mb-3"></i>
            <p class="text-slate-500 font-medium">Carrega un PDF per editar o signar</p>
            <button onclick="document.getElementById('mainPdfInput').click()" class="mt-4 text-blue-600 hover:underline">Seleccionar fitxer</button>
        </div>

        <div id="toolbar" class="hidden mb-6 flex flex-wrap gap-4 items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-100 transition-all">
            <div class="text-sm text-slate-600"><span class="font-bold text-slate-900" id="pageCount">0</span> pàgines</div>
            <div id="editTools" class="flex gap-2">
                 <button onclick="triggerAddPdf('start')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 rounded-md text-slate-700 transition"><i data-lucide="arrow-up-to-line" class="w-4 h-4"></i> Inserir inici</button>
                <button onclick="triggerAddPdf('end')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 rounded-md text-slate-700 transition"><i data-lucide="arrow-down-to-line" class="w-4 h-4"></i> Inserir final</button>
                <button onclick="openSignatureModal()" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-indigo-50 text-indigo-700 hover:bg-indigo-100 rounded-md transition border border-indigo-200 relative">
                    <i data-lucide="settings-2" class="w-4 h-4"></i> <span id="rubricStatus">Configurar Signatura</span>
                    <span id="configIndicator" class="hidden absolute top-0 right-0 -mt-1 -mr-1 w-3 h-3 bg-green-500 rounded-full border border-white"></span>
                </button>
            </div>
            <div class="border-l pl-4 border-slate-200">
                <button onclick="signWithAutoFirma()" id="cryptoSignBtn" class="flex items-center gap-2 px-4 py-1.5 text-sm bg-emerald-600 text-white hover:bg-emerald-700 rounded-md transition shadow-sm font-medium">
                    <i data-lucide="award" class="w-4 h-4"></i> Signar amb AutoFirma
                </button>
            </div>
        </div>

        <div id="signedBanner" class="hidden mb-6 bg-emerald-50 border border-emerald-200 rounded-xl p-4 flex items-center gap-3">
            <div class="bg-emerald-100 p-2 rounded-full text-emerald-600"><i data-lucide="lock" class="w-5 h-5"></i></div>
            <div><h3 class="text-emerald-800 font-bold text-sm">Document Signat Criptogràficament</h3><p class="text-emerald-600 text-xs">L'edició està bloquejada.</p></div>
        </div>
        <div id="gridContainer" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
    </main>

    <!-- Modals -->
    <div id="insertModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96">
            <h3 class="text-lg font-bold mb-4 text-slate-800">Inserir PDF extern</h3>
            <div class="mb-4"><label class="block text-xs font-medium text-slate-500 uppercase mb-1">Posició (Pàgina)</label><input type="number" id="insertPositionInput" min="1" class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none" value="1"></div>
            <div class="flex justify-end gap-3"><button onclick="document.getElementById('insertModal').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">Cancel·lar</button><button onclick="confirmInsertCustom()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg text-sm">Seleccionar</button></div>
        </div>
    </div>

    <div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96">
            <h3 class="text-lg font-bold mb-4 text-slate-800 flex items-center gap-2"><i data-lucide="settings-2" class="w-5 h-5 text-indigo-600"></i> Configuració Signatura</h3>
            <div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-2">1. Imatge / Rúbrica</label><div class="flex items-center gap-2"><button onclick="document.getElementById('signatureFileInput').click()" class="flex-grow border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 text-left truncate"><i data-lucide="image" class="w-4 h-4 inline mr-2"></i><span id="sigFileName">Seleccionar imatge...</span></button></div></div>
            <div class="mb-6"><label class="block text-xs font-bold text-slate-500 uppercase mb-2">2. Posició i Pàgina</label><div class="p-3 bg-slate-50 rounded-lg border border-slate-200"><div class="flex justify-between items-center mb-2"><span class="text-sm text-slate-700 font-medium" id="posSummary">Pàgina: Última (Defecte)</span></div><button onclick="openPositionSelector()" class="w-full bg-indigo-100 text-indigo-700 px-3 py-2 rounded text-sm hover:bg-indigo-200 font-medium flex justify-center items-center gap-2"><i data-lucide="scan-line" class="w-4 h-4"></i> Definir Àrea Visualment</button></div></div>
            <div class="flex justify-end gap-3 border-t pt-4"><button onclick="document.getElementById('signatureModal').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">Tancar</button><button onclick="applyImageSignatureVisualOnly()" class="px-4 py-2 bg-slate-200 text-slate-700 hover:bg-slate-300 rounded-lg text-sm">Aplicar Visualment</button><button onclick="saveSignatureConfig()" class="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg text-sm">Guardar per AutoFirma</button></div>
        </div>
    </div>

    <div id="positionSelectorModal" class="fixed inset-0 bg-gray-900 hidden z-[60] flex flex-col">
        <div class="bg-white p-4 flex items-center justify-between shadow-md"><h3 class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="scan-line" class="text-indigo-600"></i> Selecciona l'àrea</h3><div class="flex items-center gap-4"><div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1"><button onclick="changeSelectorPage(-1)" class="p-1 hover:bg-white rounded"><i data-lucide="chevron-left"></i></button><span id="selectorPageNum" class="text-sm font-mono w-20 text-center">Pàg 1</span><button onclick="changeSelectorPage(1)" class="p-1 hover:bg-white rounded"><i data-lucide="chevron-right"></i></button></div><button onclick="confirmPosition()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-lg">Confirmar Àrea</button><button onclick="closePositionSelector()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button></div></div>
        <div class="flex-grow overflow-auto bg-gray-800 flex justify-center p-8 cursor-crosshair relative" id="canvasScrollArea"><div class="relative shadow-2xl"><canvas id="selectionCanvas" class="bg-white"></canvas><div id="selectionHint" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-75 text-white p-4 rounded-lg pointer-events-none transition-opacity">Clica i arrossega per dibuixar el rectangle de signatura</div></div></div>
    </div>

    <div id="loader" class="loading-overlay fixed inset-0 hidden z-50 flex flex-col items-center justify-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div><p class="mt-4 text-slate-600 font-medium" id="loaderText">Processant...</p></div>

    <!-- Script de Càrrega Fallback -->
    <script>
        const { PDFDocument } = PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        // Afegim 'signedPdfBytes' per emmagatzemar el blob original
        let currentPdfDoc=null, currentFileName="document.pdf", isSigned=false, insertMode=null, uploadedSigFile=null, autoFirmaReady=false, signedPdfBytes=null; 
        let signatureConfig={isDefined:false,pageIndex:-1,rect:null};
        lucide.createIcons();

        // --- SISTEMA DE CÀRREGA HÍBRID ---
        window.onload = function() {
            // Intentem carregar l'script extern per si de cas
            const script = document.createElement('script');
            script.src = 'autoscript.js';
            script.onload = () => { console.log("autoscript.js carregat externament"); checkAndInitAutoFirma(); };
            script.onerror = () => { console.log("autoscript.js no trobat externament"); checkAndInitAutoFirma(); };
            document.head.appendChild(script);
        };

        function checkAndInitAutoFirma() {
            // 1. Comprovar si ja existeix (per enganxat inline o càrrega externa)
            if (typeof window.AutoScript !== 'undefined') {
                initializeAutoFirma();
            } else {
                // 2. Si no existeix, mostrar Modal per enganxar-lo
                updateAfStatus('error', 'Llibreria no trobada');
                document.getElementById('manualScriptLoader').classList.remove('hidden');
            }
        }

        function loadPastedScript() {
            const code = document.getElementById('pastedScriptArea').value;
            if(!code.trim()) return alert("El camp està buit");
            
            try {
                // Avaluem el codi enganxat al context global
                window.eval(code);
                
                if (typeof window.AutoScript !== 'undefined') {
                    document.getElementById('manualScriptLoader').classList.add('hidden');
                    initializeAutoFirma();
                    alert("Codi carregat correctament! AutoFirma habilitat.");
                } else {
                    alert("El codi enganxat no sembla contenir 'AutoScript'. Verifica el text.");
                }
            } catch(e) {
                alert("Error al processar el codi enganxat: " + e.message);
            }
        }

        function initializeAutoFirma() {
            updateAfStatus('loading', 'Inicialitzant...');
            if (typeof window.AutoScript.cargarApplet === 'function') {
                try { window.AutoScript.cargarApplet("appletContainer"); } catch (e) {}
            }
            setTimeout(() => {
                autoFirmaReady = true;
                updateAfStatus('success', 'Llest');
            }, 1000);
        }

        function updateAfStatus(type, text) {
            const dot = document.getElementById('afStatusDot');
            const txt = document.getElementById('afStatusText');
            txt.innerText = text;
            if (type === 'loading') dot.className = 'w-2 h-2 rounded-full bg-yellow-400 animate-pulse';
            else if (type === 'success') dot.className = 'w-2 h-2 rounded-full bg-green-500';
            else dot.className = 'w-2 h-2 rounded-full bg-red-500';
        }

        // --- FUNCIONS APP ---
        const mainInput=document.getElementById('mainPdfInput'), mergeInput=document.getElementById('mergePdfInput'), sigInput=document.getElementById('signatureFileInput');
        mainInput.addEventListener('change',async e=>{if(e.target.files[0])await loadMainPdf(e.target.files[0]);mainInput.value=''});
        mergeInput.addEventListener('change',async e=>{if(e.target.files[0])await processMergePdf(e.target.files[0]);mergeInput.value=''});
        sigInput.addEventListener('change',e=>{if(e.target.files[0]){uploadedSigFile=e.target.files[0];document.getElementById('sigFileName').innerText=uploadedSigFile.name;document.getElementById('sigFileName').classList.add('text-indigo-600','font-medium')}});

        async function loadMainPdf(f){showLoader("Carregant...");try{currentFileName=f.name;const ab=await f.arrayBuffer();currentPdfDoc=await PDFDocument.load(ab);isSigned=false;signedPdfBytes=null;signatureConfig={isDefined:false,pageIndex:-1,rect:null};updateConfigIndicator();await renderGrid();toggleUI(true)}catch(e){alert("Error:"+e.message)}finally{hideLoader()}}

        // Selector Visual
        let selectorPdfDoc=null, selectorCurrentPage=1, selectionRect=null, isDragging=false, startX, startY;
        const selCanvas = document.getElementById('selectionCanvas');

        async function openPositionSelector(){if(!currentPdfDoc)return;showLoader("Obrint selector...");const b=await currentPdfDoc.save();selectorPdfDoc=await pdfjsLib.getDocument({data:b}).promise;selectorCurrentPage=(signatureConfig.pageIndex>=0)?signatureConfig.pageIndex+1:selectorPdfDoc.numPages;selectionRect=null;document.getElementById('positionSelectorModal').classList.remove('hidden');document.getElementById('signatureModal').classList.add('hidden');await renderSelectorPage();hideLoader()}
        
        async function renderSelectorPage(){const p=await selectorPdfDoc.getPage(selectorCurrentPage);const ctx=selCanvas.getContext('2d');const vp=p.getViewport({scale:1.5});selCanvas.height=vp.height;selCanvas.width=vp.width;selCanvas.dataset.pdfW=p.getViewport({scale:1}).width;selCanvas.dataset.pdfH=p.getViewport({scale:1}).height;document.getElementById('selectorPageNum').innerText=`Pàg ${selectorCurrentPage}`;await p.render({canvasContext:ctx,viewport:vp}).promise;if(signatureConfig.pageIndex===selectorCurrentPage-1&&signatureConfig.rect&&!selectionRect){const ph=parseFloat(selCanvas.dataset.pdfH),sx=selCanvas.width/parseFloat(selCanvas.dataset.pdfW),sy=selCanvas.height/ph;selectionRect={x:signatureConfig.rect.x*sx,y:(ph-(signatureConfig.rect.y+signatureConfig.rect.h))*sy,w:signatureConfig.rect.w*sx,h:signatureConfig.rect.h*sy}}if(selectionRect){drawRect(ctx,selectionRect);document.getElementById('selectionHint').classList.add('opacity-0')}else{document.getElementById('selectionHint').classList.remove('opacity-0')}}
        
        function drawRect(ctx,r){ctx.strokeStyle='red';ctx.lineWidth=3;ctx.strokeRect(r.x,r.y,r.w,r.h);ctx.fillStyle='rgba(255,0,0,0.2)';ctx.fillRect(r.x,r.y,r.w,r.h)}
        function changeSelectorPage(d){const n=selectorCurrentPage+d;if(n>=1&&n<=selectorPdfDoc.numPages){selectorCurrentPage=n;selectionRect=null;renderSelectorPage()}}
        
        selCanvas.addEventListener('mousedown',e=>{const r=selCanvas.getBoundingClientRect();startX=e.clientX-r.left;startY=e.clientY-r.top;isDragging=true;selectionRect={x:startX,y:startY,w:0,h:0};document.getElementById('selectionHint').classList.add('opacity-0')});
        selCanvas.addEventListener('mousemove',e=>{if(!isDragging)return;const r=selCanvas.getBoundingClientRect();selectionRect.w=(e.clientX-r.left)-startX;selectionRect.h=(e.clientY-r.top)-startY;requestAnimationFrame(()=>{const ctx=selCanvas.getContext('2d');ctx.strokeStyle='red';ctx.lineWidth=2;ctx.strokeRect(selectionRect.x,selectionRect.y,selectionRect.w,selectionRect.h)})});
        selCanvas.addEventListener('mouseup',()=>{if(isDragging){isDragging=false;normalizeRect();renderSelectorPage()}});
        selCanvas.addEventListener('mouseout',()=>{if(isDragging){isDragging=false;normalizeRect();renderSelectorPage()}});
        
        function normalizeRect(){if(!selectionRect)return;if(selectionRect.w<0){selectionRect.x+=selectionRect.w;selectionRect.w=Math.abs(selectionRect.w)}if(selectionRect.h<0){selectionRect.y+=selectionRect.h;selectionRect.h=Math.abs(selectionRect.h)}}
        
        function confirmPosition(){if(!selectionRect||selectionRect.w<5)return alert("Dibuixa un rectangle vàlid");const pw=parseFloat(selCanvas.dataset.pdfW),ph=parseFloat(selCanvas.dataset.pdfH),sx=pw/selCanvas.width,sy=ph/selCanvas.height;const rw=selectionRect.w*sx,rh=selectionRect.h*sy,rx=selectionRect.x*sx,ry=ph-(selectionRect.y*sy)-rh;signatureConfig={isDefined:true,pageIndex:selectorCurrentPage-1,rect:{x:Math.round(rx),y:Math.round(ry),w:Math.round(rw),h:Math.round(rh)}};closePositionSelector();document.getElementById('signatureModal').classList.remove('hidden');document.getElementById('posSummary').innerHTML=`<span class="text-emerald-600 font-bold">Àrea Ok!</span> Pàg ${selectorCurrentPage}`}
        function closePositionSelector(){document.getElementById('positionSelectorModal').classList.add('hidden');document.getElementById('signatureModal').classList.remove('hidden')}
        function saveSignatureConfig(){document.getElementById('signatureModal').classList.add('hidden');updateConfigIndicator()}
        function updateConfigIndicator(){const ind=document.getElementById('configIndicator'),st=document.getElementById('rubricStatus');if(signatureConfig.isDefined||uploadedSigFile){ind.classList.remove('hidden');st.innerText="Signatura Llista";st.classList.add('font-bold','text-indigo-800')}else{ind.classList.add('hidden');st.innerText="Configurar Signatura";st.classList.remove('font-bold','text-indigo-800')}}
        function openSignatureModal(){if(isSigned)return;document.getElementById('signatureModal').classList.remove('hidden')}

        // SIGNATURES
        async function applyImageSignatureVisualOnly(){
            if(!uploadedSigFile)return alert("Tria imatge");showLoader("Afegint...");document.getElementById('signatureModal').classList.add('hidden');
            const b=await uploadedSigFile.arrayBuffer();let img=uploadedSigFile.type.includes('png')?await currentPdfDoc.embedPng(b):await currentPdfDoc.embedJpg(b);
            let pIdx=currentPdfDoc.getPageCount()-1,x,y,w,h;
            if(signatureConfig.isDefined){pIdx=signatureConfig.pageIndex;x=signatureConfig.rect.x;y=signatureConfig.rect.y;w=signatureConfig.rect.w;h=signatureConfig.rect.h}
            else{const p=currentPdfDoc.getPage(pIdx),d=img.scaleToFit(200,100);w=d.width;h=d.height;x=(p.getWidth()/2)-(w/2);y=50}
            currentPdfDoc.getPage(pIdx).drawImage(img,{x,y,width:w,height:h});await renderGrid();hideLoader();
        }

        async function signWithAutoFirma(){
            if(window.location.protocol==='file:')return alert("Protocol file:// no suportat per AutoFirma.");
            if(typeof window.AutoScript==='undefined')return alert("Falta AutoScript. Enganxa el codi al modal.");
            if(!autoFirmaReady){initializeAutoFirma();showLoader("Connectant...");await new Promise(r=>setTimeout(r,1000))}
            if(!currentPdfDoc)return;showLoader("Preparant...");
            try{
                const pdfB=await currentPdfDoc.save(),data=uint8ToBase64(pdfB);
                let pN=-1,llx=250,lly=100,urx=450,ury=150;
                if(signatureConfig.isDefined){pN=signatureConfig.pageIndex+1;llx=signatureConfig.rect.x;lly=signatureConfig.rect.y;urx=llx+signatureConfig.rect.w;ury=lly+signatureConfig.rect.h}
                let params=`layer2Text=Signat digitalment per $$SUBJECTCN$$ el dia $$SIGNDATE=dd/MM/yyyy$$\nsignaturePositionOnPageLowerLeftX=${llx}\nsignaturePositionOnPageLowerLeftY=${lly}\nsignaturePositionOnPageUpperRightX=${urx}\nsignaturePositionOnPageUpperRightY=${ury}\nsignaturePages=${pN}\n`;
                if(uploadedSigFile){params+="signatureRubricImage="+await blobToBase64(uploadedSigFile)}
                else if(!confirm("Signar sense imatge visual?")) {hideLoader();return}
                window.AutoScript.sign(data,"SHA512withRSA","AUTO",params,onSuccess,onError);
            }catch(e){hideLoader();alert(e.message)}
        }

        async function onSuccess(b64){
            showLoader("Processant...");
            try{
                const b=base64ToUint8(b64);
                // GUARDA ELS BYTES ORIGINALS: Això és clau per no trencar la signatura
                signedPdfBytes = b; 
                
                // Carrega a PDF-Lib NOMÉS per visualitzar (ignorant que està trencat criptogràficament en memòria)
                currentPdfDoc=await PDFDocument.load(b,{ignoreEncryption:true});
                
                isSigned=true;
                currentFileName="SIGNAT_"+currentFileName;
                await renderGrid();
                toggleUI(true);
                alert("Signat correctament! (La descàrrega mantindrà la signatura vàlida)");
            }catch(e){
                alert(e.message);
            }finally{
                hideLoader();
            }
        }
        function onError(t,m){hideLoader();alert("Error: "+m)}
        function blobToBase64(b){return new Promise((r,j)=>{const fr=new FileReader();fr.onloadend=()=>r(fr.result.split(',')[1]);fr.onerror=j;fr.readAsDataURL(b)})}
        function uint8ToBase64(u){let r='';for(let i=0;i<u.length;i+=0x8000)r+=String.fromCharCode.apply(null,u.subarray(i,i+0x8000));return btoa(r)}
        function base64ToUint8(b){const s=window.atob(b),l=s.length,y=new Uint8Array(l);for(let i=0;i<l;i++)y[i]=s.charCodeAt(i);return y}

        // Base render
        async function renderGrid(){const g=document.getElementById('gridContainer');g.innerHTML='';const c=currentPdfDoc.getPageCount();document.getElementById('pageCount').innerText=c;const d=await pdfjsLib.getDocument({data:await currentPdfDoc.save()}).promise;for(let i=0;i<c;i++){const cd=document.createElement('div');cd.className='page-card bg-white rounded-lg shadow border border-slate-200 overflow-hidden relative group';let ctrls=!isSigned?`<div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 flex items-center justify-center gap-2 transition-all opacity-0 group-hover:opacity-100">${i>0?`<button onclick="movePage(${i},-1)" class="bg-white p-2 rounded-full shadow hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>`:''}<button onclick="deletePage(${i})" class="bg-white p-2 rounded-full shadow hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c0 1 2 2 2 2v2"/></svg></button>${i<c-1?`<button onclick="movePage(${i},1)" class="bg-white p-2 rounded-full shadow hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>`:''}</div>`:'';cd.innerHTML=`<div class="p-2 bg-slate-50 border-b border-slate-100 flex justify-between items-center"><span class="text-xs font-bold text-slate-500">Pàg ${i+1}</span>${isSigned?'<i data-lucide="lock" class="w-3 h-3 text-emerald-500"></i>':''}</div><div class="h-40 flex items-center justify-center bg-slate-100 overflow-hidden relative"><canvas class="max-w-full max-h-full shadow-sm"></canvas>${ctrls}</div>`;g.appendChild(cd);const cv=cd.querySelector('canvas'),p=await d.getPage(i+1),vp=p.getViewport({scale:0.5});cv.height=vp.height;cv.width=vp.width;await p.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise}if(isSigned)lucide.createIcons()}
        async function deletePage(i){if(!isSigned&&confirm(`Esborrar?`)){showLoader("...");currentPdfDoc.removePage(i);await renderGrid();hideLoader()}}
        async function movePage(i,d){if(!isSigned){showLoader("...");const[p]=await currentPdfDoc.copyPages(currentPdfDoc,[i]);d>0?currentPdfDoc.insertPage(i+d+1,p):currentPdfDoc.insertPage(i+d,p);d>0?currentPdfDoc.removePage(i):currentPdfDoc.removePage(i+1);await renderGrid();hideLoader()}}
        function triggerAddPdf(m){if(!isSigned){insertMode=m;mergeInput.click()}}
        async function processMergePdf(f){showLoader("Fusionant...");const s=await PDFDocument.load(await f.arrayBuffer()),c=await currentPdfDoc.copyPages(s,s.getPageIndices());let x=insertMode==='start'?0:currentPdfDoc.getPageCount();for(const p of c)currentPdfDoc.insertPage(x++,p);await renderGrid();hideLoader()}
        
        async function downloadPdf(){
            showLoader("Descarregant...");
            let data;
            // SI ESTÀ SIGNAT, USEM ELS BYTES ORIGINALS D'AUTOFIRMA
            if(isSigned && signedPdfBytes) {
                data = signedPdfBytes;
            } else {
                // SI NO, GUARDEM EL PDF EDITAT
                data = await currentPdfDoc.save();
            }
            const b=new Blob([data],{type:'application/pdf'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=currentFileName;a.click();hideLoader()
        }

        function toggleUI(h){document.getElementById('emptyState').classList.toggle('hidden',h);document.getElementById('toolbar').classList.toggle('hidden',!h);document.getElementById('gridContainer').classList.toggle('hidden',!h);document.getElementById('saveBtn').disabled=!h;document.getElementById('saveBtn').classList.toggle('opacity-50',!h);if(isSigned){document.getElementById('editTools').classList.add('disabled-ui');document.getElementById('signedBanner').classList.remove('hidden');document.getElementById('cryptoSignBtn').classList.add('hidden')}else{document.getElementById('editTools').classList.remove('disabled-ui');document.getElementById('signedBanner').classList.add('hidden');document.getElementById('cryptoSignBtn').classList.remove('hidden')}lucide.createIcons()}
        function showLoader(t){document.getElementById('loaderText').innerText=t;document.getElementById('loader').classList.remove('hidden')}
        function hideLoader(){document.getElementById('loader').classList.add('hidden')}
    </script>
</body>
</html>
